npm install

npm run test

if [ $? != 0 ]
then echo TESTS HAVE FAILED; exit $?
fi


rm -r node_modules
rm package-lock.json

npm install -prod

mkdir -p ~/meterian

METERIAN_PATH=~/meterian/meterian-cli.jar
if [ ! -f "$METERIAN_PATH" ]
then wget http://meterian.com/downloads/meterian-cli.jar -O $METERIAN_PATH
fi

wget -c -N -q http://meterian.com/downloads/meterian-cli.jar -O $METERIAN_PATH

BRANCH=(${GIT_BRANCH//\//})

java -jar $METERIAN_PATH --project-url=pagesify --project-commit=$GIT_COMMIT --project-branch=$BRANCH
if [ $? != 0 ]
then echo METERIAN SCAN HAS FAILED; echo $?; exit 1
fi 

mkdir -p pagesify-build
cp -r * ./pagesify-build
cd pagesify-build 

rm -r pagesify-build resources build __tests__ README.md

cd ..
mkdir -p bin
tar -czvf ./bin/pagesify-build.tar.gz ./pagesify-build/*